<html>
    <head lang="en">
        <meta charset="UTF-8" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    </head>
        
        <style>
                * {
                  box-sizing: border-box;
                }
                
                .row {
                  display: flex;
                }
                
                /* Create two equal columns that sits next to each other */
                .column {
                  flex: 50%;
                  padding: 10px;
                  height: 300px; /* Should be removed. Only for demonstration */
                  position: relative;
                }
                #exitButton {
  position: absolute;
  bottom: 0;
  left: 0;
}
                
        </style>
        <title>Tetris Agile</title>
    </head>
    <body>
        <div class="row">
                <div class="column" id="column1">
                  <h1>Welcome To Tetris</h2>
                  <button id="playButton">Play Tetris</button>
            </div>
            <div class="column" id="column2">
                <canvas id="myCanvas" width="500" height="800" style="border:1px solid #000000;" hidden="true">
                </canvas>
            </div>
            <div class="column" id="column3">
                <h1 id="scoreTitle" hidden="true">Score : </h1>
                <h2 id="scoreDisplay" hidden='true'>0</h2>
                <button id="scoreButton1" hidden="true">1 ligne</button>
                <button id="scoreButton2" hidden="true">2 lignes</button>
                <button id="scoreButton3" hidden="true">3 lignes</button>
                <button id="scoreButton4" hidden="true">4 lignes</button>
                <input type="checkbox" id="tetrisTheme" name="TetrisTheme" onchange="PlayMusic();" hidden="true">
                <label id="ckeckBoxTheme" for="tetrisTheme" hidden="true">Enable sound</label>
                <button id="createForm" hidden="true">Créer une pièce</button>
                <input type="text" id="exportResultat" hidden="true">
                <button type="button" id="exporter" hidden="true">Exporter le resultat</button>
                <button id="exitButton" hidden="true">Exit Game</button>

            </div>
        </div>
    </body>

    <script>
        var forms = [];
        var ctx;
        $(document).ready(function(){
            ctx = document.getElementById("myCanvas").getContext("2d");
            $("#exitButton").click(function(){
                exitTetris();
 
            })
            $("#playButton").click(function(){
                runTetris();
            });
            $("#scoreButton1").click(function(){
                addScore(1);
            });
            $("#scoreButton2").click(function(){
                addScore(2);
            });
            $("#scoreButton3").click(function(){
                addScore(4);
            });
            $("#scoreButton4").click(function(){
                addScore(8);
            });
            $("#createForm").click(function() {
                forms.push(new Form());
            });
            $("#exporter").click(function () {
                exporter();
            });
        });

        function runTetris(){
            $("#playButton").hide();
            $("#title").hide();
            $("#scoreTitle").show();
            $("#myCanvas").show();
            $("#exitButton").show();
            $("#scoreDisplay").show();
            $("#scoreButton1").show();
            $("#scoreButton2").show();
            $("#scoreButton3").show();
            $("#scoreButton4").show();
            $("#createForm").show();
            $("#tetrisTheme").show();
            $("#exportResultat").show();
            $("#exporter").show();
            $("#checkBoxTheme").show();
            tetrisLoop();  
        }

        function exitTetris(){
            $("#playButton").show();
            $("#scoreTitle").hide();
            $("#myCanvas").hide();
            $("#exitButton").hide();
            $("#scoreDisplay").hide();
            $("#scoreDisplay").hide();
            $("#scoreButton1").hide();
            $("#scoreButton2").hide();
            $("#scoreButton3").hide();
            $("#scoreButton4").hide();
            $("#createForm").hide();
            $("#tetrisTheme").hide();
            $("#exportResultat").hide();
            $("#exporter").hide();
            $("#checkBoxTheme").hide();
        }

        
        function PlayMusic()
        {
            var audio = new Audio('tetris.mp3');

            if (document.getElementById('TetrisTheme').checked)
            {
                audio.play();
            }
            else
            {
                audio.pause();
                audio.currentTime = 0;
            }
        }
 
        async function tetrisLoop(){
            var timerJeu = 1;
            while(timerJeu>0){
                await sleep(800);
                timerJeu +=1;
                console.log("Pièce n° : " + timerJeu);
                draw();
                update();
            }
        }
 
        function update() {
            forms.forEach(function(element) {
                element.y += 1;
            });
        }
 
        function draw() {
            ctx.clearRect(0, 0, 500, 800);
            forms.forEach(function(element) {
                element.draw();
            });
        }
 
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
 
        var score = 0;
        function addScore(multiplier){
            score += 100 * multiplier;
            $("#scoreDisplay").text(score.toString(10));
        }
 
        function Form() {
            this.x = 2;
            this.y = -3;
            this.size = 50;
            this.pattern = createPattern(Math.random() * 6);
        }
 
        Form.prototype.draw = function() {
            ctx.fillStyle = "#FF0000";
            for(var i = 0; i < 4; i++) {
                for(var j = 0; j < 4; j++) {
                    if(this.pattern[i][j] !== 0) {
                        ctx.fillRect((this.x + i) * this.size, (this.y + j) * this.size, this.size, this.size);
                    }
                }
            }
        }

        function exporter()
        {
        let name = $("#exportResultat").val();
        let score = $("#scoreDisplay").text();
        let contenu = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(
        {
            resultat:
            {
                name: name,
                score: score,
            }
        }));
        let telechargement = $("<a></a>").attr("href", contenu).attr("download", name + ".json");
        $("body").append(telechargement);
        telechargement[0].click();
        telechargement[0].remove();
        }

        function createPattern(i) {
            if(i < 1) {
                return [
                        [0, 0, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 1, 0],
                        [0, 1, 0, 0]
                    ]
            } else if(i < 2) {
                return [
                        [0, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 0, 0]
                    ]
            } else if(i < 3) {
                return [
                        [0, 0, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 1, 0],
                        [0, 0, 1, 0]
                    ]
            } else if(i < 4) {
                return [
                        [0, 0, 0, 0],
                        [0, 1, 1, 0],
                        [0, 1, 1, 0],
                        [0, 0, 0, 0]
                    ]
            } else if(i < 5) {
                return [
                        [0, 0, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 0, 0],
                        [0, 1, 1, 0]
                    ]
            } else if(i < 6) {
                return [
                        [0, 0, 0, 0],
                        [0, 0, 1, 0],
                        [0, 1, 1, 0],
                        [0, 1, 0, 0]
                    ]
            }
        }
 
    </script>
</html>
